<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bruker</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>1603, 160 Logan Road</h1> 
    <div class="topnav">
        <a href="login.html">Login</a>
        <a href="user.html">Bruker</a>
        <a href="index.html">Hjem</a>
        <a href="vaskeregler.html">Vaskeregler</a>
        <a href="kryss.html">Kryss</a>
        <a href="sitater.html">Sitater</a>
        <a href="lardom.html">Australsk lærdom</a>
        <a href="guide.html">Skal du flytte hit?</a>
        <a href="admin.html">Admin</a>
    </div>
    <h2 id="greeting"></h2>
    <div id="taskListContainer"></div>
</body>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA_PRc6DM_i3X5lar_vcRtQyr1YVDRNq_o",
        authDomain: "logan-road.firebaseapp.com",
        databaseURL: "https://logan-road-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "logan-road",
        storageBucket: "logan-road.appspot.com",
        messagingSenderId: "659456402188",
        appId: "1:659456402188:web:1c77d675d130038141df29",
        measurementId: "G-LHYYB4FNXF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    const greeting = document.getElementById('greeting');
    const taskListContainer = document.getElementById('taskListContainer');
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                document.getElementById('greeting').innerText = `Velkommen til siden din, ${userData.fornavn}!`;
            } else {
                console.log("No such document!");
            }
        } else {
            alert("Du må logge inn, babe")
            window.location.href = 'login.html'; // Redirect to login if no user is signed in
        }
    });

    onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userRef);
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    greeting.textContent = `Hei, ${userData.fornavn}! Her er oppgavene dine for uka.`;
                    renderTasks(user.uid);
                } else {
                    greeting.textContent = 'Brukerdata ikke funnet.';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        async function renderTasks(userId) {
            const rooms = ['bathroom', 'kitchen', 'livingRoom'];
            taskListContainer.innerHTML = '';
            
            for (const room of rooms) {
                const roomRef = doc(db, 'vaskeliste', room);
                const roomDoc = await getDoc(roomRef);
                
                if (roomDoc.exists() && roomDoc.data().assignedTo === userId) {
                    const roomData = roomDoc.data();
                    const taskList = document.createElement('ul');
                    taskList.innerHTML = `<h3>${room.charAt(0).toUpperCase() + room.slice(1)}</h3>`;
                    
                    roomData.tasks.forEach((task, index) => {
                        const listItem = document.createElement('li');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = task.completed || false;
                        checkbox.addEventListener('change', () => updateTaskStatus(room, index, checkbox.checked));
                        listItem.appendChild(checkbox);
                        listItem.appendChild(document.createTextNode(task.name || task));
                        taskList.appendChild(listItem);
                    });
                    
                    taskListContainer.appendChild(taskList);
                }
            }
        }

        async function updateTaskStatus(room, index, completed) {
            const roomRef = doc(db, 'vaskeliste', room);
            const roomDoc = await getDoc(roomRef);
            
            if (roomDoc.exists()) {
                const tasks = roomDoc.data().tasks;
                tasks[index] = { name: tasks[index].name || tasks[index], completed };
                
                await updateDoc(roomRef, { tasks });
                
                const allTasksCompleted = tasks.every(task => task.completed);
                await updateDoc(roomRef, { status: allTasksCompleted });
                
                if (allTasksCompleted) {
                    alert('Alle oppgaver for rommet er fullført!');
                    console.log("Alle oppgaver fullført");
                }
            }
        }
</script>
</html>