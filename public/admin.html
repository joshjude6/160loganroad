<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 72 72'><text y='50' font-size='50'>🇦🇺</text></svg>">
</head>
<body>
    <h1>1603, 160 Logan Road</h1> 
    <div class="topnav">
        <a href="login.html">Login</a>
        <a href="user.html">Bruker</a>
        <a href="index.html">Hjem</a>
        <a href="vaskeregler.html">Vasking</a>
        <a href="kryss.html">Kryss</a>
        <a href="bingo.html">Bingo</a>
        <a href="sitater.html">Sitater</a>
        <a href="lardom.html">Australsk lærdom</a>
        <a href="guide.html">Skal du flytte hit?</a>
        <a href="admin.html">Admin</a>
    </div>
    <div id="otherContent" style="display: none;">
        <h2>Gå vekk😍, send en pull request dersom noe må endres🙏</h2>
    </div>
    <div id="adminContent" style="display: none">
        <h2>Heihei, admin!</h2>
        <h2>Innstillinger for hjemmeside</h2>
        <div class="vertical-buttons">
            <input type="text" id="newEvent" placeholder="Skriv ny event her">
            <button id="addEventButton">Legg til event</button>
            <button id="removeOldestEventButton">Fjern eldste event</button>
        </div>
        <h2>Innstillinger for sitater</h2>
        <div class="vertical-buttons">
            <button id="removeLastQuote">Fjern siste sitat</button>
            <button id="deleteAllQuotes">Fjern alle sitater</button>
            <select id="personDropdown">
                <option value="" disabled selected>Velg person</option>
                <option value="peterSitater">Peter</option>
                <option value="joshSitater">Josh</option>
                <option value="philipSitater">Philip</option>
            </select>
            <button id="deletePersonQuotes">Fjern personens sitater</button>
        </div>
        <h2>Innstillinger for vaskeliste</h2>
        <div id="assignments">
            <select id="usersDropdown"></select>
            <select id="roomsDropdown"></select>
            <button id="assignButton">Tildel rom</button>
        </div>
        <button id="resetRooms" style="margin: auto;">Reset status til alle rom</button>
        <h2>Innstillinger for kryss - WIP!</h2>
        <div class="vertical-buttons">
            <select id="personLastDropdown">
                <option value="" disabled selected>Velg person</option>
                <option value="peterSitater">Peter</option>
                <option value="joshSitater">Josh</option>
                <option value="philipSitater">Philip</option>
            </select>
            <button id="removeLastKryss">Fjern siste kryss til person</button>
        </div>
    </div>
    <p id="loadingMessage">Sjekker om du er admin eller prøver å snike deg inn...</p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getFirestore, collection, query, orderBy, getDocs, deleteDoc, doc, getDoc, updateDoc, setDoc, where, addDoc, limit } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_PRc6DM_i3X5lar_vcRtQyr1YVDRNq_o",
            authDomain: "logan-road.firebaseapp.com",
            databaseURL: "https://logan-road-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "logan-road",
            storageBucket: "logan-road.appspot.com",
            messagingSenderId: "659456402188",
            appId: "1:659456402188:web:1c77d675d130038141df29",
            measurementId: "G-LHYYB4FNXF"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);

        const personMap = {
            peterSitater: "Peter",
            joshSitater: "Josh",
            philipSitater: "Philip"
        };
        const roomMap = {
            bathroom: "Badet",
            kitchen: "Kjøkkenet", 
            livingRoom: "Stua"
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (userData.isAdmin) {
                        document.getElementById('loadingMessage').style.display = 'none';
                        document.getElementById('adminContent').style.display = 'block';
                        populateDropdowns();
                    } else {
                        document.getElementById('loadingMessage').style.display = 'none';
                        document.getElementById('otherContent').style.display = 'block';
                    }
                } else {
                    console.log("No such document!");
                    window.location.href = 'login.html'; 
                }
            } else {
                alert("Logg inn først, jeg brukte lang tid på å fikse det...");
                window.location.href = 'login.html'; 
            }
        });

        async function populateDropdowns() {
            const usersDropdown = document.getElementById('usersDropdown');
            const roomsDropdown = document.getElementById('roomsDropdown');

            const usersSnapshot = await getDocs(collection(db, 'users'));
            usersSnapshot.forEach(userDoc => {
                const userData = userDoc.data();
                const option = document.createElement('option');
                option.value = userData.fornavn;
                option.textContent = userData.fornavn;
                usersDropdown.appendChild(option);
            });

            const roomsSnapshot = await getDocs(collection(db, 'vaskeliste'));
            roomsSnapshot.forEach(roomDoc => {
                const roomData = roomDoc.data();
                const option = document.createElement('option');
                option.value = roomDoc.id;
                option.textContent = roomMap[roomDoc.id];
                roomsDropdown.appendChild(option);
            });
        }

        document.getElementById("removeLastQuote").addEventListener('click', async function() {
            try {
                let lastQuoteDoc = null;
                const persons = Object.keys(personMap);

                for (const person of persons) {
                    const q = query(collection(db, 'sitater', person, 'quotes'), orderBy('time', 'desc'));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const firstDoc = querySnapshot.docs[0];
                        if (!lastQuoteDoc || firstDoc.data().time.toDate() > lastQuoteDoc.data().time.toDate()) {
                            lastQuoteDoc = firstDoc;
                        }
                    }
                }

                if (lastQuoteDoc) {
                    await deleteDoc(doc(db, lastQuoteDoc.ref.path));
                    alert("Siste sitat fjernet!");
                } else {
                    alert("Ingen sitater å fjerne.");
                }
            } catch (error) {
                console.error("Error removing last quote: ", error);
            }
        });

        document.getElementById("deleteAllQuotes").addEventListener('click', async function() {
            try {
                const persons = Object.keys(personMap);

                for (const person of persons) {
                    const q = query(collection(db, 'sitater', person, 'quotes'));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(async (doc) => {
                        await deleteDoc(doc.ref);
                    });
                }
                alert("Alle sitater slettet!");
            } catch (error) {
                console.error("Error deleting all quotes: ", error);
            }
        });

        document.getElementById("deletePersonQuotes").addEventListener('click', async function() {
            const person = document.getElementById("personDropdown").value;
            if (person) {
                try {
                    const q = query(collection(db, 'sitater', person, 'quotes'));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(async (doc) => {
                        await deleteDoc(doc.ref);
                    });
                    alert(`Alle sitatene til ${personMap[person]} har blitt slettet!`);
                } catch (error) {
                    console.error(`Error deleting quotes from ${personMap[person]}: `, error);
                }
            } else {
                alert("Velg en person, dummy.");
            }
        });

        document.getElementById('assignButton').onclick = async () => {
            const selectedUser = document.getElementById('usersDropdown').value;
            const selectedRoom = document.getElementById('roomsDropdown').value;

            const userDoc = await getDocs(collection(db, 'users'), where('fornavn', '==', selectedUser));
            const userId = userDoc.docs[0].id;

            await updateDoc(doc(db, 'vaskeliste', selectedRoom), { assignedTo: selectedUser });
            await updateDoc(doc(db, 'users', userId), { assignedRoom: selectedRoom });

            alert('Rommet har blitt tildelt en person!');
        }
        document.getElementById('resetRooms').onclick = async () => {
            const roomsSnapshot = await getDocs(collection(db, 'vaskeliste'));
            roomsSnapshot.forEach(async (roomDoc) => {
                await updateDoc(doc(db, 'vaskeliste', roomDoc.id), { status: false });
            });
            alert('Alle rom er dirty igjen :D!');
        }

        document.getElementById("removeLastKryss").addEventListener('click', async function() {
            const person = document.getElementById("personLastDropdown").value;
            const personLowerCase = person.toLowerCase();
            if (person) {
                try {
                    const kryssRef = collection(db, 'kryss', personLowerCase + 'Kryss', 'entries');
                    const kryssQuery = query(kryssRef, orderBy('time', 'desc'), limit(1));
                    const querySnapshot = await getDocs(kryssQuery);
                    if (!querySnapshot.empty) {
                        const kryssDoc = querySnapshot.docs[0];
                        await deleteDoc(doc(db, kryssDoc.ref.path));
                        alert(`Siste kryss til ${personMap[person]} har blitt fjernet!`);
                    } else {
                        alert(`Ingen kryss funnet for ${personMap[person]}.`);
                    }
                } catch (error) {
                    console.error(`Error removing last kryss from ${personMap[person]}: `, error);
                }
            } else {
                alert("Velg en person, dummy.");
            }
        });

        document.getElementById("addEventButton").addEventListener('click', async function() {
            const newEvent = document.getElementById("newEvent").value;
            if (newEvent) {
                try {
                    const eventDocRef = await addDoc(collection(db, 'events'), {
                        event: newEvent,
                        time: new Date()
                    });
                    alert("Ny hendelse lagt til!");
                    document.getElementById("newEvent").value = "";  // Clear the input field
                } catch (error) {
                    console.error("Error adding event: ", error);
                }
            } else {
                alert("Skriv inn en hendelse.");
            }
        });

        document.getElementById("removeOldestEventButton").addEventListener('click', async function() {
            try {
                const q = query(collection(db, 'events'), orderBy("time", "asc"), limit(1));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const oldestEventDoc = querySnapshot.docs[0];
                    await deleteDoc(doc(db, 'events', oldestEventDoc.id));
                    alert("Eldste hendelse fjernet!");
                } else {
                    alert("Ingen hendelser å fjerne.");
                }
            } catch (error) {
                console.error("Error removing oldest event: ", error);
            }
        });


    </script>
</body>
</html>
