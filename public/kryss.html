<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krysseregler</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 72 72'><text y='50' font-size='50'>ðŸ‡¦ðŸ‡º</text></svg>">
</head>
<body>
    <h1>1603, 160 Logan Road</h1> 
    <div class="topnav">
        <a href="login.html">Login</a>
        <a href="user.html">Bruker</a>
        <a href="index.html">Hjem</a>
        <a href="vaskeregler.html">Vasking</a>
        <a href="kryss.html">Kryss</a>
        <a href="bingo.html">Bingo</a>
        <a href="sitater.html">Sitater</a>
        <a href="lardom.html">Australsk lÃ¦rdom</a>
        <a href="guide.html">Skal du flytte hit?</a>
        <a href="admin.html">Admin</a>
    </div>
    <h2>Melding av kryss</h2>
    <p>Reglene for kryss er TBA!</p>
    <div class="input-bar">
        <select id="inputName">
            <option value="" disabled selected>Hvem meldes?</option>
            <option value="Peter">Peter</option>
            <option value="Josh">Josh</option>
            <option value="Philip">Philip</option>
        </select>
        <input type="text" id="hvorfor" placeholder="Hvorfor?">
        <input type="number" id="antallKryss" min="1" max="10" placeholder="Antall kryss?">
        <select id="hvemMeldte" placeholder="Fra hvem?">
            <option value="" disabled selected>Hvem meldte?</option>
            <option value="Peter">Peter</option>
            <option value="Josh">Josh</option>
            <option value="Philip">Ian Philip</option>
        </select>
        <button id="submitBtn">Submit</button>
    </div>

    <div id="chartContainer">
        <canvas id="myChart"></canvas>
    </div>

    <table id="entriesTable">
        <thead>
            <tr>
                <th>Hvem meldes pÃ¥?</th>
                <th>Hvorfor?</th>
                <th>Antall kryss?</th>
                <th>Hvem meldte?</th>
            </tr>
        </thead>
        <tbody id="entriesTableBody">
        </tbody>
    </table>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, where, updateDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        import { getDatabase } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyA_PRc6DM_i3X5lar_vcRtQyr1YVDRNq_o",
            authDomain: "logan-road.firebaseapp.com",
            databaseURL: "https://logan-road-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "logan-road",
            storageBucket: "logan-road.appspot.com",
            messagingSenderId: "659456402188",
            appId: "1:659456402188:web:1c77d675d130038141df29",
            measurementId: "G-LHYYB4FNXF"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
    
        let chartInstance = null;
    
    document.getElementById("submitBtn").addEventListener('click', async function() {
    const name = document.getElementById("inputName").value;
    const reason = document.getElementById("hvorfor").value;
    const crosses = document.getElementById("antallKryss").value;
    const reporter = document.getElementById("hvemMeldte").value;

    if (name && reason && crosses && reporter) {
        try {
            console.log("Adding document to Firestore");
            const nameLowerCase = name.toLowerCase();
            const docRef = await addDoc(collection(db, 'kryss', nameLowerCase + 'Kryss', 'entries'), {
                name: name,
                reason: reason,
                crosses: Number(crosses),
                reporter: reporter,
                time: serverTimestamp()
            });
            console.log("Document added with ID: ", docRef.id);

            // Query the user with the correct first name
            const userQuery = query(collection(db, 'users'), where('fornavn', '==', name));
            const userSnapshot = await getDocs(userQuery);

            if (!userSnapshot.empty) {
                // Find the user with the exact first name match
                let userDoc;
                userSnapshot.forEach(doc => {
                    if (doc.data().fornavn === name) {
                        userDoc = doc;
                    }
                });

                if (userDoc) {
                    const userData = userDoc.data();
                    const newTotalCrosses = (userData.totalCrosses || 0) + Number(crosses);
                    await updateDoc(doc(db, 'users', userDoc.id), { totalCrosses: newTotalCrosses });
                    console.log("Crosses updated for user ID: ", userDoc.id);
                } else {
                    console.error("No user found with the exact first name match.");
                }
            } else {
                console.error("No user found with the given first name.");
            }

            alert("Kryss meldt!");
            displayEntries();
        } catch (error) {
            console.error("Error reporting crosses: ", error);
        }
    } else {
        alert("Fyll ut alle feltene ðŸ˜¡");
    }
    });



    
        async function displayEntries() {
            const entriesTableBody = document.getElementById('entriesTableBody');
            entriesTableBody.innerHTML = ''; // Clear existing entries
    
            let entriesArray = [];
            const persons = ["peterKryss", "joshKryss", "philipKryss"];
    
            for (const person of persons) {
                console.log("Fetching entries for: ", person);
                const q = query(collection(db, 'kryss', person, 'entries'), orderBy('time', 'desc'));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    entriesArray.push(doc.data());
                });
            }
    
            console.log("Entries fetched: ", entriesArray);
    
            entriesArray.sort((a, b) => b.time.toDate() - a.time.toDate());
    
            entriesArray.forEach((entry) => {
                const date = entry.time.toDate();
                const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                entriesTableBody.innerHTML += `
                    <tr>
                        <td>${entry.name}</td>
                        <td>${entry.reason}</td>
                        <td>${entry.crosses}</td>
                        <td>${entry.reporter}</td>
                    </tr>
                `;
            });
    
            console.log("Entries displayed in table");
            displayChart(entriesArray);
        }
    
        function displayChart(entriesArray) {
            const ctx = document.getElementById('myChart').getContext('2d');
    
            const names = ["Peter", "Josh", "Philip"];
            const crossesData = [0, 0, 0];
    
            entriesArray.forEach((entry) => {
                const index = names.indexOf(entry.name);
                if (index !== -1) {
                    crossesData[index] += entry.crosses;
                }
            });
    
            if (chartInstance) {
                chartInstance.destroy();
            }
    
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Antall kryss',
                        data: crossesData,
                        backgroundColor: ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)'],
                        borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            console.log("Chart updated");
        }
    
        displayEntries();
    </script>    
</body>
</html>
